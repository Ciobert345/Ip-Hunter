<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Hunter ‚Äì Gioco</title>
    <style>
        :root {
            --bg: #0f1115;
            --surface: #161a20;
            --muted: #232a34;
            --text: #e6e8eb;
            --text-muted: #aab3bd;
            --brand: #3b82f6; /* blue-500 */
            --brand-600: #2563eb;
            --brand-700: #1d4ed8;
            --accent: #22d3a3; /* teal */
            --warn: #f59e0b;
            --danger: #ef4444;
            --shadow: 0 10px 30px rgba(0,0,0,0.35);
            --radius: 14px;
        }
        @media (prefers-color-scheme: dark) {
            :root { color-scheme: dark; }
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial, sans-serif;
            background: radial-gradient(1200px 600px at 10% -10%, rgba(59,130,246,0.15), transparent 40%),
            radial-gradient(1000px 500px at 110% 10%, rgba(34,211,163,0.12), transparent 40%),
            var(--bg);
            color: var(--text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 24px;
        }
        .container {
            width: 90%;
            max-width: 720px;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)) var(--surface);
            padding: 28px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.06);
            backdrop-filter: blur(6px);
        }
        h1 {
            font-size: 2.1rem;
            margin: 0 0 18px 0;
            letter-spacing: 0.3px;
        }
        .value-box {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)) var(--muted);
            padding: 16px 18px 18px 18px;
            margin-bottom: 20px;
            border-radius: 10px;
            position: relative;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .timer {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, var(--brand), var(--accent));
            padding: 6px 14px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 1.05rem;
            box-shadow: 0 6px 16px rgba(34,211,163,0.3);
        }
        .timer.warning { background: linear-gradient(135deg, var(--warn), #ffb84d); animation: pulse 1s ease-in-out infinite; }
        .timer.danger { background: linear-gradient(135deg, var(--danger), #ff6b6b); animation: pulse 0.55s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.06); } }
        input, select, button {
            width: 100%;
            padding: 12px 14px;
            margin-bottom: 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.08);
            font-size: 1rem;
            outline: none;
            transition: border-color .2s, box-shadow .2s, background .2s, transform .06s;
        }
        input, select {
            background: #11161c;
            color: var(--text);
        }
        input::placeholder, select:invalid { color: var(--text-muted); opacity: 0.9; }
        input:focus, select:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 4px rgba(59,130,246,0.15);
        }
        button {
            background: linear-gradient(135deg, var(--brand), var(--brand-600));
            color: #fff;
            cursor: pointer;
            font-weight: 700;
            letter-spacing: .2px;
            border: none;
            box-shadow: 0 10px 20px rgba(37,99,235,0.25);
        }
        button:hover { background: linear-gradient(135deg, var(--brand-600), var(--brand-700)); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled { background: #39414d; color: #c0c6cf; cursor: not-allowed; box-shadow: none; }
        .result { font-size: 1.1rem; font-weight: 700; margin-top: 10px; min-height: 1.5em; }
        .warning-box {
            background: linear-gradient(180deg, rgba(245,158,11,0.15), rgba(245,158,11,0.12));
            color: #ffd89a;
            padding: 14px 16px;
            border-radius: 10px;
            margin-bottom: 18px;
            font-weight: 700;
            border: 1px solid rgba(245,158,11,0.25);
        }
        .info { background: #203040; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .stats {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .stat-item {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)) var(--muted);
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.06);
            min-width: 160px;
        }
        .stat-item div:first-child { color: var(--text-muted); font-weight: 600; font-size: 0.9rem; }
        .stat-value { font-size: 1.6rem; font-weight: 800; color: var(--brand); }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: #1b212a;
            border-radius: 999px;
            overflow: hidden;
            margin-bottom: 18px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--brand), var(--accent));
            transition: width 0.3s ease;
        }
        @media (max-width: 420px) {
            .container { padding: 22px; }
            h1 { font-size: 1.8rem; }
        }
        @media (prefers-reduced-motion: reduce) {
            * { transition: none !important; animation: none !important; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è IP Hunter</h1>

    <div id="game-status" class="warning-box" style="display:none;">
        ‚è∏Ô∏è La partita non √® ancora iniziata. Attendi l'admin!
    </div>

    <div class="stats">
        <div class="stat-item">
            <div>Il tuo punteggio</div>
            <div class="stat-value" id="personal-score">0</div>
        </div>
        <div class="stat-item">
            <div>Quiz completati</div>
            <div class="stat-value" id="quiz-count">0</div>
        </div>
    </div>

    <input type="text" id="username" placeholder="Il tuo nome (obbligatorio)">

    <div id="quiz-container" style="display:none;">
        <p><b>Indovina la classe, la rete e il broadcast dell'indirizzo mostrato:</b></p>

        <div class="value-box">
            <div class="timer" id="timer">30s</div>
            <div><b>IP:</b> <span id="ip">-</span></div>
            <div><b>Mask:</b> <span id="mask">-</span></div>
        </div>

        <div class="progress-bar" aria-label="Tempo rimanente">
            <div class="progress-fill" id="progress"></div>
        </div>

        <select id="classe">
            <option value="">Seleziona Classe IP</option>
            <option value="A">Classe A </option>
            <option value="B">Classe B </option>
            <option value="C">Classe C </option>
        </select>

        <input type="text" id="rete" placeholder="Indirizzo di rete (es: 192.168.1.0)">
        <input type="text" id="broadcast" placeholder="Broadcast (es: 192.168.1.255)">

        <button id="check-btn" onclick="controlla()">‚úì Controlla Risposta</button>

        <div class="result" id="result" aria-live="polite"></div>
    </div>

    <button id="start-btn" onclick="iniziaGioco()" style="display:none;">üöÄ Inizia a Giocare!</button>
</div>

<script>
    let currentUsername = "";
    let gameActive = false;
    let currentQuizId = "";
    let timeLeft = 0;
    let timerInterval = null;
    let quizCount = 0;
    let timeLimit = 30;
    let lastResetTimestamp = 0;
    let isPlayingQuiz = false;

    setInterval(checkGameStatus, 3000);

    function checkGameStatus() {
        fetch("/api/status")
            .then(r => r.json())
            .then(j => {
                gameActive = j.gameActive;

                // Controlla se c'√® stato un reset
                if (j.resetTimestamp && j.resetTimestamp > lastResetTimestamp && lastResetTimestamp > 0) {
                    resetClientState();
                }
                lastResetTimestamp = j.resetTimestamp || 0;

                updateUI();
            })
            .catch(err => console.error("Errore controllo stato:", err));
    }

    function resetClientState() {
        // Reset completo dello stato del client
        document.getElementById("personal-score").textContent = "0";
        document.getElementById("quiz-count").textContent = "0";
        quizCount = 0;
        stopTimer();
        isPlayingQuiz = false;

        if (gameActive && currentUsername) {
            // Se la partita √® ancora attiva, ricarica un quiz dopo un attimo
            setTimeout(() => {
                caricaNuovoQuiz();
            }, 500);
        }
    }

    function updateUI() {
        const statusDiv = document.getElementById("game-status");
        const startBtn = document.getElementById("start-btn");
        const quizContainer = document.getElementById("quiz-container");
        const usernameInput = document.getElementById("username");
        const username = usernameInput.value.trim();

        if (!gameActive) {
            statusDiv.style.display = "block";
            quizContainer.style.display = "none";
            startBtn.style.display = "none";
            stopTimer();
            isPlayingQuiz = false;

            // Se aveva gi√† iniziato a giocare, resetta lo stato
            if (currentUsername) {
                currentUsername = "";
                usernameInput.style.display = "block";
                usernameInput.disabled = false;
                usernameInput.value = "";
            }
        } else if (username && !currentUsername) {
            // Partita attiva e utente ha inserito il nome ma non ha ancora iniziato
            statusDiv.style.display = "none";
            startBtn.style.display = "block";
            quizContainer.style.display = "none";
        } else if (currentUsername) {
            // Utente sta gi√† giocando
            statusDiv.style.display = "none";
            startBtn.style.display = "none";
            quizContainer.style.display = "block";
        }
    }

    function iniziaGioco() {
        const username = document.getElementById("username").value.trim();
        if (!username) {
            alert("Inserisci il tuo nome prima di iniziare!");
            return;
        }

        if (!gameActive) {
            alert("La partita non √® ancora iniziata! Attendi l'admin.");
            return;
        }

        currentUsername = username;

        // Nascondi campo nome e bottone inizia
        document.getElementById("username").style.display = "none";
        document.getElementById("start-btn").style.display = "none";

        // Mostra container del quiz
        document.getElementById("quiz-container").style.display = "block";

        caricaNuovoQuiz();
    }

    function caricaNuovoQuiz() {
        if (!gameActive) {
            alert("La partita √® terminata!");
            return;
        }

        if (isPlayingQuiz) {
            return; // Non caricare un nuovo quiz se ce n'√® gi√† uno in corso
        }

        isPlayingQuiz = true;

        fetch(`/api/new?user=${encodeURIComponent(currentUsername)}`)
            .then(r => r.json())
            .then(j => {
                if (j.error) {
                    alert(j.error);
                    isPlayingQuiz = false;
                    return;
                }

                currentQuizId = j.quizId;
                timeLimit = j.timeLimit || 30;
                timeLeft = timeLimit;

                document.getElementById("ip").textContent = j.ip;
                document.getElementById("mask").textContent = j.mask;
                document.getElementById("result").textContent = "";

                // Reset campi
                document.getElementById("classe").value = "";
                document.getElementById("rete").value = "";
                document.getElementById("broadcast").value = "";

                // Abilita bottone
                document.getElementById("check-btn").disabled = false;

                // Avvia timer
                startTimer();
            })
            .catch(err => {
                console.error("Errore:", err);
                alert("Errore nel caricamento del quiz");
                isPlayingQuiz = false;
            });
    }

    function startTimer() {
        stopTimer();
        updateTimerDisplay();

        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();

            if (timeLeft <= 0) {
                stopTimer();
                tempoScaduto();
            }
        }, 1000);
    }

    function stopTimer() {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    function updateTimerDisplay() {
        const timerEl = document.getElementById("timer");
        const progressEl = document.getElementById("progress");

        timerEl.textContent = timeLeft + "s";

        const percentage = (timeLeft / timeLimit) * 100;
        progressEl.style.width = percentage + "%";

        // Colori in base al tempo rimasto
        if (timeLeft <= 5) {
            timerEl.className = "timer danger";
            progressEl.style.background = "#dc3545";
        } else if (timeLeft <= 10) {
            timerEl.className = "timer warning";
            progressEl.style.background = "#ff8c00";
        } else {
            timerEl.className = "timer";
            progressEl.style.background = "linear-gradient(90deg, #0d6efd, #00ff80)";
        }
    }

    function tempoScaduto() {
        document.getElementById("check-btn").disabled = true;
        document.getElementById("result").textContent = "‚è∞ Tempo scaduto!";
        document.getElementById("result").style.color = "#ff8c00";

        isPlayingQuiz = false;

        setTimeout(() => {
            if (gameActive) caricaNuovoQuiz();
        }, 2000);
    }

    function controlla() {
        const cl = document.getElementById("classe").value;
        const net = document.getElementById("rete").value.trim();
        const br = document.getElementById("broadcast").value.trim();

        if (!cl || !net || !br) {
            alert("Compila tutti i campi!");
            return;
        }

        stopTimer();
        document.getElementById("check-btn").disabled = true;

        const url = `/api/check?user=${encodeURIComponent(currentUsername)}&quizId=${currentQuizId}&class=${cl}&network=${net}&broadcast=${br}`;

        fetch(url)
            .then(r => r.json())
            .then(j => {
                if (j.error) {
                    alert(j.error);
                    isPlayingQuiz = false;
                    return;
                }

                // Aggiorna punteggio
                document.getElementById("personal-score").textContent = j.score;

                if (j.timeExpired) {
                    document.getElementById("result").textContent = "‚è∞ Tempo scaduto!";
                    document.getElementById("result").style.color = "#ff8c00";
                } else if (j.ok) {
                    quizCount++;
                    document.getElementById("quiz-count").textContent = quizCount;
                    document.getElementById("result").textContent = "‚úî Corretto! +1 punto";
                    document.getElementById("result").style.color = "#00ff80";
                } else {
                    document.getElementById("result").textContent = "‚úò Sbagliato! Riprova nel prossimo quiz";
                    document.getElementById("result").style.color = "#ff8080";
                }

                isPlayingQuiz = false;

                // Carica nuovo quiz dopo 2 secondi
                setTimeout(() => {
                    if (gameActive) caricaNuovoQuiz();
                }, 2000);
            })
            .catch(err => {
                console.error("Errore:", err);
                alert("Errore nella verifica");
                document.getElementById("check-btn").disabled = false;
                isPlayingQuiz = false;
            });
    }

    checkGameStatus();
</script>
</body>
</html>